<!doctype html> <html class="no-js" lang="ja"> <head> <meta charset="utf-8" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <title>Pandasで何かに白黒つけたい</title> <link rel="stylesheet" href="https://moni360.github.io/assets/css/styles_feeling_responsive.css"> <script src="https://moni360.github.io/assets/js/modernizr.min.js"></script> <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script> <script> WebFont.load({ google: { families: [ 'Lato:400,700,400italic:latin', 'Volkhov::latin' ] } }); </script> <noscript> <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic|Volkhov' rel='stylesheet' type='text/css'> </noscript> <meta name="google-site-verification" content="" /> <meta name="msvalidate.01" content="" /> <meta name="description" content="もふもふPandasに触れてみようの巻"/> <link rel="author" href=""/> <link rel="icon" sizes="32x32" href="https://moni360.github.io/assets/img/favicon-32.png"> <link rel="icon" sizes="192x192" href="https://moni360.github.io/assets/img/touch-icon-192.png"> <link rel="apple-touch-icon-precomposed" sizes="180x180" href="https://moni360.github.io/assets/img/touch-icon-180.png"> <link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://moni360.github.io/assets/img/touch-icon-152.png"> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://moni360.github.io/assets/img/touch-icon-144.png"> <link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://moni360.github.io/assets/img/touch-icon-120.png"> <link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://moni360.github.io/assets/img/touch-icon-114.png"> <link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://moni360.github.io/assets/img/touch-icon-76.png"> <link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://moni360.github.io/assets/img/touch-icon-72.png"> <link rel="apple-touch-icon-precomposed" href="https://moni360.github.io/assets/img/touch-icon-57.png"> <meta name="msapplication-TileImage" content="https://moni360.github.io/assets/img/touch-icon-144.png"/> <meta name="msapplication-TileColor" content="#fabb00"> <!-- Facebook Optimization --> <meta property="og:locale" content="" /> <meta property="og:type" content="website" /> <meta property="og:title" content="Pandasで何かに白黒つけたい" /> <meta property="og:description" content="Arduino, Raspberry pi, FPGA, Python, Androidなど趣くままに色々なことを"/> <meta property="og:url" content="https://moni360.github.io//blog/2015/08/studying-pandas-1/" /> <meta property="og:site_name" content="Moni blog" /> <!-- Search Engine Optimization --> <link type="text/plain" rel="author" href="https://moni360.github.io/humans.txt" /> </head> <body id="top-of-page" class="post"> <div id="navigation" class="sticky"> <nav class="top-bar" data-topbar> <ul class="title-area"> <li class="name"> <h1 class="show-for-small-only"><a href="https://moni360.github.io" class="icon-tree"> Moni blog</a></h1> </li> <!-- Remove the class "menu-icon" to get rid of menu icon. Take out "Menu" to just have icon alone --> <li class="toggle-topbar menu-icon"><a href="#"><span>Navigation</span></a></li> </ul> <section class="top-bar-section"> <ul class="left"> <li><a href="https://moni360.github.io/">Home</a></li> <li class="divider"></li> <li><a href="https://moni360.github.io/info/">About</a></li> <li class="divider"></li> <li class="has-dropdown"> <a href="https://moni360.github.io/blog/">Blog</a> <ul class="dropdown"> <li><a href="https://moni360.github.io/blog/">Blog</a></li> <li><a href="https://moni360.github.io/blog/archive/">Blog Archive</a></li> </ul> </li> <li class="divider"></li> </ul> <ul class="right"> <li class="divider"></li> <li class="has-dropdown"> <a href="https://moni360.github.io/">Services</a> <ul class="dropdown"> <li><a href="https://moni360.github.io/feed.xml">RSS</a></li> <li><a href="https://moni360.github.io/sitemap.xml">Sitemap</a></li> </ul> </li> <li class="divider"></li> <li><a href="https://moni360.github.io/search/">Search</a></li> </ul> </section> </nav> </div><!-- /#navigation --> <div id="masthead-no-image-header"> <div class="row"> <div class="small-2 columns"></div> <div class="small-10 columns"> <a id="logo" href="https://moni360.github.io" title="Moni blog – 予告されない開発の記録"> <img src="https://moni360.github.io/assets/img/logo.png" alt="Moni blog – 予告されない開発の記録"> </a> </div><!-- /.small-12.columns --> </div><!-- /.row --> </div><!-- /#masthead --> <nav class="breadcrumbs" role="menubar" aria-label="breadcrumbs"> <li><a href="https://moni360.github.io">Home</a></li> <li><a href="https://moni360.github.io/blog/"> blog </a> <li><a href="https://moni360.github.io/blog/2015/08/"> 2015/08 </a> <li class="current">Pandasで何かに白黒つけたい</li> </nav> <div class="row t30"> <div class="medium-8 columns"> <article itemscope itemtype="http://schema.org/Article"> <header> <span itemprop="name"> <h1>Pandasで何かに白黒つけたい</h1> </span> </header> <p class="teaser" itemprop="description"> もふもふPandasに触れてみようの巻 </p> <span itemprop="articleSection"> <h2>長い前置き</h2> <p>プログラミング初心者で、基本的に独学なMoniは、自分のプログラミングに対する芯的な部分というか、バックグラウンド的なものがグラグラとしているという自覚があります。 </p> <p>私が好きな漫画家の福満しげゆき先生も何かの漫画の中で同じようなことを述べられていたと思います。<br> 確か、自分という人間は基礎的な部分がグラグラしている、とかなんとか。<br> エッセイでも似たタイトルのものを出されているみたいです。<br> <a href="http://www.amazon.co.jp/%E3%82%B0%E3%83%A9%E3%82%B0%E3%83%A9%E3%81%AA%E7%A4%BE%E4%BC%9A%E3%81%A8%E3%82%B0%E3%83%A9%E3%82%B0%E3%83%A9%E3%81%AA%E5%83%95%E3%81%AE%E3%81%BE%E3%82%93%E3%81%8C%E9%81%93-%E7%A6%8F%E6%BA%80-%E3%81%97%E3%81%92%E3%82%86%E3%81%8D/dp/4845910489">グラグラな社会とグラグラな僕のまんが道</a></p> <p>当時大学生でモラトリアムを謳歌していた私は、その表現にとても共感してしまったものですが、いい大人な年齢になった今でも感覚はそんなに変わっていなくて、ふとした時に焦燥感を覚えています。<br> しかし、最近はいっそ、グラグラなことが自分のアイデンティティーなのかなと考えて開き直るようにしています（できる社会人のビジネス用語では、これを臭いものに蓋といいます）。 </p> <p>さて、ちょうど先ほど、福満先生の<a href="http://www.amazon.co.jp/%E3%81%86%E3%81%A1%E3%81%AE%E5%A6%BB%E3%81%A3%E3%81%A6%E3%81%A9%E3%81%86%E3%81%A7%E3%81%97%E3%82%87%E3%81%86%EF%BC%9F-7-%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%B3%E3%83%9F%E3%83%83%E3%82%AF%E3%82%B9-%E7%A6%8F%E6%BA%80-%E3%81%97%E3%81%92%E3%82%86%E3%81%8D/dp/4575944475/ref=pd_sim_14_7?ie=UTF8&amp;refRID=03A8T48D984VC4QPR2B2">うちの妻ってどうでしょう？(7)（最終巻）</a>を読んだのですが、 この巻を最後に連載が全く無くなり失業状態になるそうなので、天地神明に誓ってステマの類ではないですが、 みなさんも興味があったら福満先生の漫画を買ってあげてください。</p> <h2>What&#39;s Pandas？</h2> <p>さて、だいぶ話が逸れましたがプログラグラミングの話をしましょう。<br> いや、私はプロではないのでグラグラミングになるのでしょうか。<br> とにかく、グラグラな私はプログラミング界隈に疎いのですが、Pythonでデータ分析を行う、PyDataというものが流行っているらしいと日課のネットサーフィンをしていたら小耳に挟んだのです。<br> なになに…データを扱うにはPandasというパッケージを使えばいい？他に必要なmatplotlibやnumpyなら学生時代に少し使ったことあるなあ…<br> とにかくデータ分析ってかっこいいし、Pandasについて勉強してみよう！ </p> <p>ということで、公式にあるチュートリアルの<a href="http://pandas.pydata.org/pandas-docs/stable/10min.html">10 Minutes to pandas</a>を読みました。</p> <h2>何を分析するか</h2> <p>なんでもいいのですが、最近プロ野球をよく観ているのでプロ野球のデータにしました。 </p> <p>データの取得方法は、NPBのウェブページへのアクセスでhtmlから取得することにします。<br> データは各チームの選手の基本情報（名前、背番号、生年月日、etc.）を取ることにします。<br> アウトプットは、各球団の選手の年齢分布を表示することとします。</p> <h2>コーディングする</h2> <p>まず骨組みを考え、全体を2つの関数に分けることにしました。<br> ・指定されたチームの選手データを取得し、DataFrame形式で返す。<br> ・指定されたチームの全選手の満年齢をヒストグラム表示する。</p> <h4>選手データ取得</h4> <p>urllib2でhtmlを取得。<br> こんな感じで、引数で&#39;db&#39;とかのチーム名を入れて、各チームのデータを取得できるようにしておきました。 </p> <div class="highlight"><pre><code class="language-text" data-lang="text">req = urllib2.Request(&#39;http://bis.npb.or.jp/teams/rst_%s.html&#39; % team_name)
</code></pre></div> <h4>HTMLの分析</h4> <p>BeautifulSoupを使って分析をします。あったかい(略)<br> これも初めて使うので、<a href="http://kondou.com/BS4/">Beautiful Soup 4.2.0 Doc. 日本語訳</a>を読みました。</p> <p>まず、選手データがあるDivだけfindで抽出します。<br> 次に、その中からfind<em>allで、全てのテーブルを検索します。<br> ここで、find</em>allを使用した理由は、育成選手がいる場合、支配下選手とテーブルが分かれているからです。 </p> <div class="highlight"><pre><code class="language-text" data-lang="text">soup = BeautifulSoup(html)

# HTMLから選手のテーブルの部分だけ抽出
main_div = soup.find(&#39;div&#39;, id=&#39;tedivmaintbl&#39;)
# すべてのtableタグを検索
table_list = main_div.find_all(&#39;table&#39;)
</code></pre></div> <p>次に、テーブルの子要素を読み、DataFrameに追加していきます。<br> for文でタグの子要素を取得するには、contentsとchildren属性を使う方法があるらしいです。 contentsはリストで格納されていて、childrenはイテレータとのこと。<br> とりあえずcontentsを使いました。</p> <p>ここで、よくわからなかったのが、contentsのリストの中にu&quot;\n&quot;というNavigableString objが入ってくることでした。 邪魔なので、省くために、<code>from bs4 import element as bs4element</code>としてBeautifulSoupからelementクラスをインポートしておいて、<code>isinstance(row, bs4element.Tag)</code>で、Tag objのときだけ処理するようにしました（よい方法なのか不明）。</p> <p>各行の要素は、<code>[x.string for x in row.contents]</code>のようにリスト内包表記を使い、string要素だけ取得しました。</p> <p>取得した行データをデータフレームに1行ずつ逐次追加したかったので、以下のようにappendメソッドを使いました。<br> リストのappendとは異なり、破壊的に追加されていくわけではないようです。 </p> <div class="highlight"><pre><code class="language-text" data-lang="text">s = pd.Series(data, index=header)
df = df.append(s, ignore_index=True)
</code></pre></div> <p>全体は以下のような感じです。</p> <div class="highlight"><pre><code class="language-text" data-lang="text">df = pd.DataFrame()
for table in table_list:
    for row in table.contents:
        # 間に空行のNavigableString objが入ってくるのでTag objに絞る
        if isinstance(row, bs4element.Tag):
            if row[&#39;class&#39;][0] == &#39;rosterMainHead&#39;:
                # ポジション名を保存しておく
                position = row.find(&#39;th&#39;, class_=&quot;rosterPos&quot;).string
                # テーブルをまとめて扱えるように列名を名前に変更
                row.find(&#39;th&#39;, class_=&quot;rosterPos&quot;).string.replace_with(&#39;Name&#39;)
                # 1列目にポジション列を追加
                header = [&#39;Position&#39;] + [x.string for x in row.contents]
            elif row[&#39;class&#39;][0] == &#39;rosterPlayer&#39;:
                # 1列目にポジションを追加
                data = [position] + [x.string for x in row.contents]
                s = pd.Series(data, index=header)
                df = df.append(s, ignore_index=True)
</code></pre></div> <h4>データの成形</h4> <p>データフレームに追加したデータは、dtypesでみると、全てオブジェクトタイプになっています。 このままでは不便そうなのでいい感じに型を変換したいです。</p> <div class="highlight"><pre><code class="language-text" data-lang="text">print df.dtypes
# Name        object
# No.         object
# Position    object
# 備考          object
# 生年月日        object
# 体重          object
# 打           object
# 投           object
# 身長          object
# dtype: object
</code></pre></div> <p>身長、体重は数値に変換したいです。<br> astypeを使えばいいようです。<br> 監督の身長・体重データは掲載されていないので、dropnaで省きます。<br> そもそも選手じゃないのでデータから消すべきかもしれませんが。</p> <div class="highlight"><pre><code class="language-text" data-lang="text"># 身長、体重の型を変換
df[u&#39;身長&#39;] = df[u&#39;身長&#39;].dropna(how=&#39;any&#39;).astype(int)
df[u&#39;体重&#39;] = df[u&#39;体重&#39;].dropna(how=&#39;any&#39;).astype(int)
</code></pre></div> <p>生年月日も計算で使用できるようにします。<br> 初期状態ではYYYY.MM.DDの形式になっているので、YYYY-MM-DDになるように文字列置換してから、to_datetimeメソッドで変換します。<br> 文字列データを取得するにはstrアクセサを使えばいいようです。</p> <div class="highlight"><pre><code class="language-text" data-lang="text"># 生年月日の型を変換
df[u&#39;生年月日&#39;] = pd.to_datetime(df[u&#39;生年月日&#39;].str.replace(&#39;.&#39;, &#39;-&#39;))
</code></pre></div> <p>投打は、統計に便利そうなのでカテゴリカルデータに変換します。 身長・体重と同様に、投打も監督のデータは掲載されていないので、dropnaで省きます。</p> <div class="highlight"><pre><code class="language-text" data-lang="text"># 投打をカテゴリカルデータに変換
df[u&#39;投&#39;] = df[u&#39;投&#39;].dropna(how=&#39;any&#39;).astype(&#39;category&#39;)
df[u&#39;打&#39;] = df[u&#39;打&#39;].dropna(how=&#39;any&#39;).astype(&#39;category&#39;)
</code></pre></div> <p>これで以下のような型になりました。<br> なぜか、intを指定した身長・体重がfloat64になっていますが。。 </p> <div class="highlight"><pre><code class="language-text" data-lang="text">print df.dtypes
Name                object
No.                 object
Position            object
備考                  object
生年月日        datetime64[ns]
体重                 float64
打                 category
投                 category
身長                 float64
dtype: object
</code></pre></div> <h4>データのプロット</h4> <p>さて、ようやくまとめたデータを使う段階に入ることができました。<br> いま一度わたしの野望を思い出してみますと、目標は各球団の選手の年齢分布を表示することでした。</p> <p>選手の満年齢を計算します。 生年月日から満年齢を計算するには閏年とかあるし、一体わたしどうしたらいいの〜？<br> 思わず取り乱してしまいましたが、気を取り直して正座してお上品におググりましたところ、下記のような記事が見つかりました。<br> <a href="http://s0hno.net/archives/109">閏年も考えた上での年齢の計算方法</a></p> <p>年月日をくっつけてint型として、(今日の日付-生年月日)/10000して小数点を切り捨てればいいと。<br> な〜るほど！<br> せっかく日付をdatetime型にしたのに〜(＞＜)と思いながら以下のように書きました。 </p> <div class="highlight"><pre><code class="language-text" data-lang="text"># 現在の年月日をintで
t = int(pd.tslib.Timestamp.now().strftime(&#39;%Y%m%d&#39;))
# 選手の満年齢を求める
year = df[u&#39;生年月日&#39;].apply(lambda x: math.floor((t - int(x.strftime(&#39;%Y%m%d&#39;)))/10000))
</code></pre></div> <p>このデータをヒストグラムでプロットします。<br> <code>kind=&#39;hist&#39;</code>でヒストグラムになります。 binsはバーの数、alphaは透明度、colorはバーの色です。</p> <div class="highlight"><pre><code class="language-text" data-lang="text"># ヒストグラムをプロットして表示
year.plot(kind=&#39;hist&#39;, bins=20, alpha=0.5, color=&#39;b&#39;, xlim=(15, 50), ylim=(0, 15))
plt.show()
</code></pre></div> <h2>結果</h2> <p>というわけで、結果です。<br> 年俸が12球団最低で若い印象のdb軍と、年齢層高めの印象のcd軍を表示してみました。 db軍は選手としてノってくるであろう30手前の選手が最も多いことがわかります。<br> cd軍は確かに40代の選手が多いですが、22〜24の選手も多いとわかります。これから期待できますね。 </p> <div class="row"> <div class="large-6 columns"> DB軍 <img src="https://moni360.github.io/images/figure_db.png"> </div> <div class="large-6 columns"> CD軍 <img src="https://moni360.github.io/images/figure_d.png"> </div> </div> <p>さて、何かに白黒つけることはできたのでしょうか。<br> また今度、もう少し有意義な分析もしてみたいです。</p> <p>今回のコードは以下です。<br> <a href="https://gist.github.com/moni360/b688c8c8d365b003d977">plot_hist.py</a></p> </span> <div id="page-meta" class="t30"> <p> <!-- Look the author details up from the site config. --> <!-- Output author details if some exist. --> <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name" class="pr20 icon-edit"><a href="https://github.com/moni360" target="_blank"> Moni</a></span> </span> <time class="icon-calendar pr20" datetime="2015-08-01" itemprop="datePublished"> <a href="https://moni360.github.io/blog/2015/08"> 2015-08-01 </a> </time> <span class="icon-archive pr20"> <a href="https://moni360.github.io/blog/category/programming"> PROGRAMMING </a> </span> <br> <span class="pr20"><span class="icon-price-tag pr10"> <a href="https://moni360.github.io/blog/tag/python">python</a> </span><span class="icon-price-tag pr10"> <a href="https://moni360.github.io/blog/tag/pandas">pandas</a> </span><span class="icon-price-tag pr10"> <a href="https://moni360.github.io/blog/tag/データ分析">データ分析</a> </span><span class="icon-price-tag pr10"> <a href="https://moni360.github.io/blog/tag/プロ野球">プロ野球</a> </span></span> </p> <div id="post-nav" class="row"> <div class="small-5 columns"><a class="button small radius prev" href="https://moni360.github.io/blog/2015/07/customize-blog/">&laquo; Blogをカス...</a></div><!-- /.small-4.columns --> <div class="small-5 columns text-right"><a class="button small radius next" href="https://moni360.github.io/blog/2015/08/windows-bat-memo/">仕事でよく使う... &raquo;</a></div><!-- /.small-4.columns --> </div> </div><!-- /.page-meta --> <h3 id="comments" class="t60">Comments</h3> <div id="disqus_thread"></div> <script type="text/javascript"> /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */ var disqus_shortname = 'moni360'; var disqus_identifier = '/blog/2015/08/studying-pandas-1/'; /* * * DON'T EDIT BELOW THIS LINE * * */ (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> </article> </div><!-- /.medium-8.columns --> <div class="medium-4 columns"> <aside> <div class="panel radius"> <h3>新しい記事</h3> <a href="https://moni360.github.io/blog/2015/08/windows-bat-date-and-time/" title="バッチで日付と時刻を取得するを読む"><strong>バッチで日付と時刻を取得する</strong></a> 2015-08-20<br /> <a href="https://moni360.github.io/blog/2015/08/windows-bat-memo/" title="仕事でよく使うWindowsバッチファイルのあれこれを読む"><strong>仕事でよく使うWindowsバッチファイルのあれこれ</strong></a> 2015-08-16<br /> <a href="https://moni360.github.io/blog/2015/07/customize-blog/" title="Blogをカスタマイズするを読む"><strong>Blogをカスタマイズする</strong></a> 2015-07-23<br /> <a href="https://moni360.github.io/blog/2015/07/first-post/" title="初めての投稿を読む"><strong>初めての投稿</strong></a> 2015-07-19<br /> </div> <div class="panel radius"> <h3>関連する記事</h3> 他の記事がありません </div> <h3>Tag Cloud</h3> <span class="site-tag"> <a href="/blog/tag/Windows/" style="font-size: 108%"> Windows (2) </a> </span> <span class="site-tag"> <a href="/blog/tag/bat/" style="font-size: 108%"> bat (2) </a> </span> <span class="site-tag"> <a href="/blog/tag/pandas/" style="font-size: 94%"> pandas (1) </a> </span> <span class="site-tag"> <a href="/blog/tag/python/" style="font-size: 94%"> python (1) </a> </span> <span class="site-tag"> <a href="/blog/tag/テスト/" style="font-size: 94%"> テスト (1) </a> </span> <span class="site-tag"> <a href="/blog/tag/データ分析/" style="font-size: 94%"> データ分析 (1) </a> </span> <span class="site-tag"> <a href="/blog/tag/プロ野球/" style="font-size: 94%"> プロ野球 (1) </a> </span> <span class="site-tag"> <a href="/blog/tag/日記/" style="font-size: 94%"> 日記 (1) </a> </span> <span class="site-tag"> <a href="/blog/tag/自動化/" style="font-size: 108%"> 自動化 (2) </a> </span> </aside> </div><!-- /.medium-4.columns --> </div><!-- /.row --> <div id="up-to-top" class="row"> <div class="small-12 columns" style="text-align: right;"> <a class="iconfont" href="#top-of-page">&#xf108;</a> </div><!-- /.small-12.columns --> </div><!-- /.row --> <footer id="footer-content" class="bg-grau"> <div id="subfooter"> <nav class="row"> <section id="subfooter-left" class="b30 small-12 medium-6 columns"> <ul class="inline-list"> <li>Copyright (c) 2015 Moni, All Rights Reserved.</li> </ul> </section> <section id="subfooter-right" class="small-12 medium-6 columns social-icons"> <ul class="inline-list"> <li><a href="http://github.com/moni360" target="_blank" class="icon-github" title="作ったコードなど"></a></li> </ul> </section> </nav> </div><!-- /#subfooter --> </footer> <script src="https://moni360.github.io/assets/js/javascript.min.js"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-65303984-1', 'auto'); ga('set', 'anonymizeIp', true); ga('send', 'pageview'); </script> </body> </html>
